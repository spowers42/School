function D = disparity_ncorr(L, R)
    % Compute disparity map D(y, x) such that: L(y, x) = R(y, x + D(y, x))
    %
    % L: Grayscale left image
    % R: Grayscale right image, same size as L
    % D: Output disparity map, same size as L, R

    window = 11;
    half_window = floor(window/2);
    D = zeros(size(L));
    L = padarray(L, [window, window]);
    R = padarray(R, [window, window]);
    
    for row=1:size(L,1)-window+1
       strip = R(row-ha:row+window-1, :);
       parfor x=1:size(L,2)-window+1
           patch = L(row-half_window:row+half_window, x-half_window:x+half_window);
           c = normxcorr2(patch, strip)
           [~, x_idx] = find(c == max(c(:)));
           D(row, x) = x-x_idx;
       end
    end
end
